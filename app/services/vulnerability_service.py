from services.vulnerability_processor import VulnerabilityProcessor
from models.database import DatabaseConnection

class VulnerabilityService:
    def __init__(self, db_config, model):
        self.db_config = db_config
        self.processor = VulnerabilityProcessor(model)

    def fetch_similar_vulnerabilities(self):
        with DatabaseConnection(**self.db_config) as conn:
            vulnerabilities = self.processor.fetch_all_vulnerabilities(conn)
            endpoint_groups = self.processor.group_by_endpoint(vulnerabilities)

            grouped_vulnerabilities = []
            for endpoint, group in endpoint_groups.items():
                grouped_vulnerabilities.extend(self.processor.compute_similarity_groups(group))

            return self.processor.assign_tags(grouped_vulnerabilities)